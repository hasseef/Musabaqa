
import { storage } from './state.js'; import { uid } from './utils.js';
const COMP_KEY='musabaqa_comps', SUBM_KEY='musabaqa_submissions', SCORE_KEY='musabaqa_scores', PRIZE_KEY='musabaqa_prizes';
const WALLET_KEY='musabaqa_wallet', PLEDGE_KEY='musabaqa_pledges'; const FEE_RATE_MAX=0.05;
const seed=[
 {id:'c1',title:'Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø§Ø¨ØªÙƒØ§Ø±',org:'Ø§Ù„Ù…Ù†ØµØ©',category:'ÙˆØ·Ù†ÙŠ',status:'open',deadline:'2025-12-31',brief:'Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ·Ù†ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù…Ø¹ Ø±Ø¹Ø§Ø© ÙˆØ´Ø±ÙƒØ§Ø¡.',rubric:[{k:'Ø§Ù„Ø£Ø«Ø±',w:0.4},{k:'Ø§Ù„Ø¬Ø¯ÙˆÙ‰',w:0.3},{k:'Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±',w:0.3}],requiresCode:false,code:'',videoUrl:'',stickers:['ðŸ‡¸ðŸ‡¦','ðŸŒŸ'],featured:true,budget:200000,feeRate:0.05,form:[{id:'q1',type:'radio',title:'Ù‡Ù„ Ø§Ù„ÙÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ',options:['Ù†Ø¹Ù…','Ù„Ø§'],correct:'Ù†Ø¹Ù…'}], needsSponsorship:true, funding:{required:150000,collected:30000,pledges:[]} },
 {id:'c2',title:'Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø¶Ø±ÙŠ',org:'Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©',category:'ØªØµÙ…ÙŠÙ…',status:'soon',deadline:'2025-12-05',brief:'Ø£ÙÙƒØ§Ø± Ù„Ø¥Ø­ÙŠØ§Ø¡ Ø§Ù„Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©.',rubric:[{k:'Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©',w:0.35},{k:'Ø§Ù„ÙØ§Ø¦Ø¯Ø©',w:0.35},{k:'Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©',w:0.3}],requiresCode:false,code:'',videoUrl:'',stickers:['ðŸŒ¿','âœ¨'],featured:false,budget:50000,feeRate:0.03,form:[{id:'q1',type:'radio',title:'Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©',options:['Ù…ÙÙ‡ÙˆÙ…','Ù†Ù…Ø°Ø¬Ø© Ø«Ù„Ø§Ø«ÙŠØ©','Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†ÙÙŠØ°'],correct:'Ù†Ù…Ø°Ø¬Ø© Ø«Ù„Ø§Ø«ÙŠØ©'}], needsSponsorship:false, funding:{required:0,collected:0,pledges:[]} }
];
export const comps=()=>{let c=storage.read(COMP_KEY); if(!c){storage.write(COMP_KEY,seed); c=seed;} return c}; export const saveComps=a=>storage.write(COMP_KEY,a);
export const submissions=()=>storage.read(SUBM_KEY,[]); export const saveSubmissions=a=>storage.write(SUBM_KEY,a);
export const scoresStore=()=>storage.read(SCORE_KEY,[]); export const saveScores=a=>storage.write(SCORE_KEY,a);
export const prizeClaims=()=>storage.read(PRIZE_KEY,[]); export const savePrizeClaims=a=>storage.write(PRIZE_KEY,a);
export const wallet=()=>storage.read(WALLET_KEY,{balance:0,invoices:[]}); export const saveWallet=w=>storage.write(WALLET_KEY,w);
export const pledges=()=>storage.read(PLEDGE_KEY,[]); export const savePledges=p=>storage.write(PLEDGE_KEY,p);
export const computeFee=(budget,feeRate)=>{const rate=Math.min(feeRate??FEE_RATE_MAX,FEE_RATE_MAX); const b=Number(budget||0); return Math.round(b*rate)};
export const createComp=p=>{const arr=comps(); const id=uid(); const feeRate=Math.min(Number(p.feeRate??0.05),FEE_RATE_MAX); arr.push({id,requiresCode:false,code:'',videoUrl:'',stickers:[],featured:false,budget:0,feeRate,rubric:[],form:[],needsSponsorship:false,funding:{required:0,collected:0,pledges:[]},...p}); saveComps(arr); return id;};
export const createSubmission=p=>{const arr=submissions(); arr.push({id:uid(),at:Date.now(),winner:false,...p}); saveSubmissions(arr);};
export const markWinner=(submId,isWinner=true)=>{const arr=submissions(); const i=arr.findIndex(s=>s.id===submId); if(i>-1){arr[i].winner=isWinner; saveSubmissions(arr)}};
export const INVOICE_TYPES={ SPONSOR_PLEDGE:'SPONSOR_PLEDGE', SPONSOR_PACKAGE:'SPONSOR_PACKAGE', SELF_FUND:'SELF_FUND' };
export function createInvoice(payload){ const w=wallet(); w.invoices.push({ id: uid(), status: payload.status||'unpaid', createdAt: Date.now(), paymentMethod: payload.paymentMethod||null, paymentUrl: payload.paymentUrl||null, ...payload }); saveWallet(w); }
export function markInvoicePaid(id){ const w=wallet(); const i=w.invoices.findIndex(x=>x.id===id); if(i>-1){ w.invoices[i].status='paid'; w.invoices[i].paidAt=Date.now(); w.balance+=Number(w.invoices[i].amount||0); saveWallet(w);} }
export function markInvoicePending(id, method){ const w=wallet(); const i=w.invoices.findIndex(x=>x.id===id); if(i>-1){ w.invoices[i].status='pending'; w.invoices[i].paymentMethod=method; w.invoices[i].paymentUrl = w.invoices[i].paymentUrl || ('https://pay.example/'+id); saveWallet(w);} }
export function createPledge({compId, sponsorEmail, amount, visibilityTier='bronze', note=''}){ const p=pledges(); const id=uid(); p.push({id, compId, sponsorEmail, amount:Number(amount||0), visibilityTier, note, status:'pending', invoiceId:null, createdAt:Date.now(), updatedAt:Date.now()}); savePledges(p); createInvoice({ title:'ØªØ¹Ù‡Ø¯ Ø±Ø¹Ø§ÙŠØ©', amount:Number(amount||0), type:INVOICE_TYPES.SPONSOR_PLEDGE, compId, sponsorEmail, status:'unpaid' }); return id; }
export function setPledgeStatus(pledgeId, status){ const p=pledges(); const i=p.findIndex(x=>x.id===pledgeId); if(i>-1){p[i].status=status; p[i].updatedAt=Date.now(); savePledges(p); if(status==='approved'){ const cs=comps(); const ci=cs.findIndex(c=>c.id===p[i].compId); if(ci>-1){ cs[ci].funding=cs[ci].funding||{required:0,collected:0,pledges:[]}; cs[ci].funding.collected = Number(cs[ci].funding.collected||0) + Number(p[i].amount||0); saveComps(cs);} } }}
export function selfFundCompetition({ compId, creatorEmail, amount }){ amount=Number(amount||0); if(!amount||amount<=0) return false; const cs=comps(); const idx=cs.findIndex(x=>x.id===compId); if(idx<0) return false; cs[idx].funding=cs[idx].funding||{required:0,collected:0,pledges:[]}; cs[idx].funding.collected=Number(cs[idx].funding.collected||0)+amount; saveComps(cs); createInvoice({ title: 'Self-fund: '+cs[idx].title, amount, status:'paid', type:INVOICE_TYPES.SELF_FUND, compId, sponsorEmail:creatorEmail }); return true; }
export const canExposeSponsorship = (accountType)=> (accountType==='government'||accountType==='nonprofit');
export const createPrizeClaim=p=>{const arr=prizeClaims(); arr.push({id:uid(),status:'pending',createdAt:Date.now(),...p}); savePrizeClaims(arr)}; export const updatePrizeStatus=(id,status)=>{const arr=prizeClaims(); const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i].status=status; arr[i].updatedAt=Date.now(); savePrizeClaims(arr)}};
export function featuredStories(){ return comps().filter(c=>c.featured).map(c=>({ id:c.id, title:c.title, slides:[ {type:'cover',text:c.title}, {type:'text',text:c.brief}, {type:'cta',text:'Ù‚Ø¯Ù‘Ù… Ø§Ù„Ø¢Ù†',href:'#/submit/'+c.id} ] })); }
