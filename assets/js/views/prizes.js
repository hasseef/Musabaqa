
import { getAuth } from '../auth.js'; import { submissions, comps, prizeClaims, createPrizeClaim } from '../data.js';
export default function Prizes(){ const u=getAuth(); if(!u) return '<div class="card"><p>فضلاً سجّل الدخول.</p></div>'; const wins=submissions().filter(s=>s.author===u.email && s.winner); const claims=prizeClaims().filter(p=>p.winnerEmail===u.email);
  const winRows=wins.map(m=>{const c=comps().find(x=>x.id===m.compId); return `<tr><td>${c?.title??'-'}</td><td>${m.title}</td><td>${m.id.slice(0,6)}</td><td><button class="btn btn--light" data-claim="${m.id}" data-comp="${c?.id}">طلب استلام</button></td></tr>`;}).join('')||`<tr><td colspan="4" class="muted">لا توجد مشاركات متوجة حالياً.</td></tr>`;
  const claimRows=claims.map(p=>`<tr><td>${p.id.slice(0,6)}</td><td>${p.compId}</td><td>${p.submId.slice(0,6)}</td><td>${p.iban}</td><td>${p.status}</td></tr>`).join('')||`<tr><td colspan="5" class="muted">لا توجد طلبات</td></tr>`;
  return `<section class="grid"><div class="card"><h2>استلام الجوائز</h2><h3>مشاركاتك المتوجة</h3><table class="table"><thead><tr><th>المسابقة</th><th>المشاركة</th><th>#</th><th>طلب</th></tr></thead><tbody>${winRows}</tbody></table><hr/><h3>طلباتك</h3><table class="table"><thead><tr><th>#</th><th>المسابقة</th><th>المشاركة</th><th>IBAN</th><th>الحالة</th></tr></thead><tbody>${claimRows}</tbody></table></div></section><dialog id="claimModal" class="modal"><form method="dialog" class="modal__content" id="claimForm"><button class="modal__close" value="close" aria-label="إغلاق">×</button><h3>طلب استلام الجائزة</h3><input type="hidden" name="compId"><input type="hidden" name="submId"><label>IBAN<input class="input" name="iban" placeholder="SA..." required></label><label>رقم الهوية/الإقامة<input class="input" name="idNumber" required></label><label>ملاحظات (اختياري)<textarea name="note"></textarea></label><button class="btn">إرسال الطلب</button></form></dialog><script type="module">import { createPrizeClaim } from '../data.js'; const modal=document.getElementById('claimModal'); const form=document.getElementById('claimForm'); document.querySelectorAll('[data-claim]').forEach(btn=>btn.addEventListener('click',()=>{ form.compId.value=btn.getAttribute('data-comp'); form.submId.value=btn.getAttribute('data-claim'); modal.showModal(); })); form.addEventListener('submit',e=>{ e.preventDefault(); const fd=new FormData(form); createPrizeClaim({ compId:fd.get('compId'), submId:fd.get('submId'), winnerEmail:(JSON.parse(localStorage.getItem('musabaqa_auth'))?.email||'user@demo'), iban:fd.get('iban'), idNumber:fd.get('idNumber'), note:fd.get('note')||'' }); alert('تم إرسال الطلب'); modal.close(); location.reload(); }); </script>`; }