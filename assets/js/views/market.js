import { getAuth } from '../auth.js'; import { comps, createPledge } from '../data.js'; import { pct } from '../utils.js'; export default function Market(){ const u=getAuth(); if(!u || (u.accountType!=='sponsor' && u.role!=='admin')) return '<div class="card"><p>هذه الصفحة للرعاة والمديرين فقط.</p></div>'; const list=comps().filter(c=>c.needsSponsorship); const cards=list.map(c=>`<div class="card"><h3>${c.title}</h3><p class="muted">${c.org} • ${c.category}</p><div class='progress'><span style='width:${pct(c.funding?.collected||0,c.funding?.required||0)}%'></span></div><p class='muted'>المطلوب: ${c.funding?.required||0} • المجمّع: ${c.funding?.collected||0}</p><form class='pledge grid' data-id='${c.id}'><label>المبلغ (ريال)<input class='input' name='amount' type='number' min='1' required></label><label>مستوى الظهور<select name='tier' class='input'><option value='bronze'>برونزي</option><option value='silver'>فضي</option><option value='gold'>ذهبي</option></select></label><label>ملاحظات (اختياري)<input class='input' name='note'></label><button class='btn'>رعاية الآن</button></form></div>`).join('') || '<div class="card"><p class="muted">لا توجد مسابقات تنتظر الرعاية الآن.</p></div>'; return `<section class='grid grid-3'>${cards}</section><script type='module'>import { createPledge } from '../data.js'; document.querySelectorAll('form.pledge').forEach(f=>f.addEventListener('submit',(e)=>{e.preventDefault(); const fd=new FormData(f); const compId=f.dataset.id; const amount=Number(fd.get('amount')||0); const tier=fd.get('tier')||'bronze'; const note=fd.get('note')||''; if(!amount||amount<=0){ alert('أدخل مبلغًا صحيحًا'); return; } createPledge({ compId, sponsorEmail: (JSON.parse(localStorage.getItem('musabaqa_auth'))?.email||'sponsor@demo'), amount, visibilityTier:tier, note }); alert('تم تسجيل تعهد الرعاية والفاتورة. يرجى السداد من المحفظة.'); location.hash='#/wallet'; }));</script>`; }