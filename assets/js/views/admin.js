
import { getAuth } from '../auth.js';
import { comps, createComp, submissions, scoresStore, computeFee, markWinner, prizeClaims, updatePrizeStatus, selfFundCompetition, canExposeSponsorship } from '../data.js';
import { fmtDate, downloadFile } from '../utils.js';
export default function Admin(){ const u=getAuth(); if(!u) return '<div class="card"><p>ูุถูุงู ุณุฌูู ุงูุฏุฎูู.</p></div>'; if(u.role!=='admin') return '<div class="card"><p>ูุฐู ุงูููุทูุฉ ูููุฏุฑุงุก ููุท.</p></div>';
  const list=comps(); const rows=list.map(c=>`<tr><td>${c.title}</td><td>${c.org}</td><td>${c.category}</td><td>${c.status}</td><td>${fmtDate(c.deadline)}</td><td>${c.budget??0}</td><td>${computeFee(c.budget,c.feeRate)}</td><td>${c.featured?'ูุนู':'-'}</td><td>${c.needsSponsorship?'ูุนู':'-'}</td></tr>`).join('');
  const subs=submissions(); const subsRows=subs.map(s=>`<tr><td>${s.id.slice(0,6)}</td><td>${s.title}</td><td>${s.author}</td><td>${s.winner?'๐':''}</td><td><button class="btn btn--light" data-win="${s.id}">${s.winner?'ุฅูุบุงุก ููุฒ':'ุชุชููุฌ ููุงุฆุฒ'}</button></td></tr>`).join('')||`<tr><td colspan="5" class="muted">ูุง ูุดุงุฑูุงุช</td></tr>`;
  const claims=prizeClaims(); const claimRows=claims.map(p=>`<tr><td>${p.id.slice(0,6)}</td><td>${p.winnerEmail}</td><td>${p.compId}</td><td>${p.submId.slice(0,6)}</td><td>${p.iban}</td><td>${p.status}</td><td><select class="input" data-claim="${p.id}"><option ${p.status==='pending'?'selected':''} value="pending">ููุฏ ุงูุงุณุชูุงู</option><option ${p.status==='review'?'selected':''} value="review">ููุฏ ุงููุฑุงุฌุนุฉ</option><option ${p.status==='approved'?'selected':''} value="approved">ูุนุชูุฏ ููุฏูุน</option><option ${p.status==='paid'?'selected':''} value="paid">ุชู ุงูุณุฏุงุฏ</option></select></td></tr>`).join('')||`<tr><td colspan="7" class="muted">ูุง ุทูุจุงุช ุฌูุงุฆุฒ</td></tr>`;
  return `<section class="grid"><div class="card"><h2>ุฅุฏุงุฑุฉ ุงููุณุงุจูุงุช</h2><form id="newComp" class="grid grid-2"><label>ุงูุนููุงู<input class="input" name="title" required></label><label>ุงูุฌูุฉ<input class="input" name="org" required></label><label>ุงููุฆุฉ<input class="input" name="category" required></label><label>ุงูุญุงูุฉ<select name="status"><option value="open">ููุชูุญุฉ</option><option value="soon">ูุฑูุจุงู</option><option value="closed">ูุบููุฉ</option></select></label><label>ุขุฎุฑ ููุนุฏ<input class="input" name="deadline" type="date" required></label><label>ุงูููุฒุงููุฉ (ุฑูุงู)<input class="input" name="budget" type="number" step="100" placeholder="0"></label><label>ูุณุจุฉ ุงูููุตุฉ (โค5%)<input class="input" name="feeRate" type="number" step="0.01" min="0" max="0.05" value="0.05"></label><label>ูููุฒุฉ ูุทููุฉุ<select name="featured"><option value="false">ูุง</option><option value="true">ูุนู</option></select></label><label>ูุตู<textarea name="brief" required></textarea></label><label>ูุชุทูุจ ุฑูุฒุ<select name="requiresCode"><option value="false">ูุง</option><option value="true">ูุนู</option></select></label><label>ุงูุฑูุฒ<input class="input" name="code"></label><label>ุฑุงุจุท ููุฏูู<input class="input" name="videoUrl" placeholder="https://...mp4"></label><label>ููุตูุงุช ุจููุงุตู<input class="input" name="stickers" placeholder="๐ฅ,โจ"></label><label>ูุนุงููุฑ (ุงูุงุณู:ุงููุฒู ุจููุงุตู)<input class="input" name="rubric" placeholder="ุงูุฃุซุฑ:0.4,ุงูุฌุฏูู:0.3,ุงูุงุจุชูุงุฑ:0.3"></label><label>ุฃุณุฆูุฉ (type:ุณุคุงู:ุฎ1|ุฎ2:ุงูุตุญูุญุ checkbox ุงูุตุญูุญ & ุจูู ุงูุฎูุงุฑุงุช)<textarea name="form"></textarea></label><label>ุชุญุชุงุฌ ุฑุนุงูุฉุ<select name="needsSponsorship"><option value="false">ูุง</option><option value="true">ูุนู</option></select></label><label>ุชูููู ุงูุฌูุงุฆุฒ ุงููุทููุจ (ุฑูุงู)<input class="input" name="fundRequired" type="number" step="100" placeholder="0"></label><div class="row"><button class="btn">ุฅุถุงูุฉ</button><span id="feePreview" class="note"></span></div></form></div><div class="card"><h3>ุงููุงุฆูุฉ ุงูุญุงููุฉ</h3><table class="table"><thead><tr><th>ุงูุนููุงู</th><th>ุงูุฌูุฉ</th><th>ุงููุฆุฉ</th><th>ุงูุญุงูุฉ</th><th>ุงูุญุฏ ุงูููุงุฆู</th><th>ุงูููุฒุงููุฉ</th><th>ุนูููุฉ ุงูููุตุฉ</th><th>ูุทููุฉ</th><th>ุชุญุชุงุฌ ุฑุนุงูุฉ</th></tr></thead><tbody>${rows}</tbody></table><div class="row"><button class="btn btn--light" id="exportCsv">ุชุตุฏูุฑ CSV</button></div><hr/><h3>ุชูููู ุฐุงุชู ูู ุงููุญูุธุฉ</h3><form id="selfFundForm" class="grid grid-2"><label>ุงููุณุงุจูุฉ<select class="input" name="compIdSel"></select></label><label>ุงููุจูุบ (ุฑูุงู)<input class="input" name="amount" type="number" min="1" required></label><button class="btn">ุชูููู ุงูุขู</button></form></div></section><section class="grid"><div class="card"><h3>ุชุชููุฌ ุงููุงุฆุฒูู</h3><table class="table"><thead><tr><th>#</th><th>ุงูุนููุงู</th><th>ุงููุดุงุฑู</th><th>ุงูุญุงูุฉ</th><th>ุฅุฌุฑุงุก</th></tr></thead><tbody>${subsRows}</tbody></table></div><div class="card"><h3>ุทูุจุงุช ุงุณุชูุงู ุงูุฌูุงุฆุฒ</h3><table class="table"><thead><tr><th>#</th><th>ุงููุงุฆุฒ</th><th>ุงููุณุงุจูุฉ</th><th>ุงููุดุงุฑูุฉ</th><th>IBAN</th><th>ุงูุญุงูุฉ</th><th>ุชุญุฏูุซ</th></tr></thead><tbody>${claimRows}</tbody></table></div></section><script type="module">import { getAuth } from '../auth.js'; import { createComp, comps, submissions, scoresStore, computeFee, markWinner, prizeClaims, updatePrizeStatus, selfFundCompetition, canExposeSponsorship } from '../data.js'; import { downloadFile } from '../utils.js'; const form=document.getElementById('newComp'); const feePrev=document.getElementById('feePreview'); const auth=getAuth(); if(auth && !canExposeSponsorship(auth.accountType)){ form.querySelector('[name=needsSponsorship]').closest('label').style.display='none'; } form.addEventListener('input',()=>{const fd=new FormData(form); feePrev.textContent='ุชูุฏูุฑ ุนูููุฉ ุงูููุตุฉ: '+computeFee(Number(fd.get('budget')||0), Number(fd.get('feeRate')||0.05))+' ุฑูุงู';}); function parseForm(str){const out=[];(str||'').split('\n').map(s=>s.trim()).filter(Boolean).forEach(line=>{const [type,title,opts,correct]=line.split(':'); const options=(opts||'').split('|').filter(Boolean); let corr=correct||''; if(type==='checkbox'){corr=corr.split('&').filter(Boolean);} out.push({id:Math.random().toString(36).slice(2),type,title,options,correct:corr});}); return out;} form.addEventListener('submit',e=>{e.preventDefault(); const fd=new FormData(form); const rubric=(fd.get('rubric')||'').split(',').filter(Boolean).map(x=>{const [k,w]=x.split(':'); return {k:k?.trim(),w:Number(w)};}); const stickers=(fd.get('stickers')||'').split(',').map(s=>s.trim()).filter(Boolean); const formQs=parseForm(fd.get('form')); createComp({ title:fd.get('title'), org:fd.get('org'), category:fd.get('category'), status:fd.get('status'), deadline:fd.get('deadline'), brief:fd.get('brief'), budget:Number(fd.get('budget')||0), feeRate:Number(fd.get('feeRate')||0.05), featured:fd.get('featured')==='true', requiresCode:fd.get('requiresCode')==='true', code:fd.get('code')||'', videoUrl:fd.get('videoUrl')||'', stickers, rubric, form:formQs, needsSponsorship:(fd.get('needsSponsorship')==='true')&&canExposeSponsorship(auth?.accountType), funding:{required:Number(fd.get('fundRequired')||0), collected:0, pledges:[]} }); alert('ุชูุช ุงูุฅุถุงูุฉ'); location.reload(); }); const toCSV=(rows,headers)=>[headers.join(',') ,...rows.map(r=>headers.map(h=>`"${String(r[h]??'').replaceAll('"','""')}"`).join(','))].join('\n'); document.getElementById('exportCsv').addEventListener('click',()=>{const rows=comps(); const csv=toCSV(rows,['id','title','org','category','status','deadline','budget','feeRate','featured','needsSponsorship']); downloadFile('competitions.csv',csv);}); document.querySelectorAll('[data-win]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-win'); const isWinner=b.textContent.includes('ุชุชููุฌ'); markWinner(id,isWinner); alert('ุชู ุงูุชุญุฏูุซ'); location.reload(); })); document.querySelectorAll('select[data-claim]').forEach(sel=>sel.addEventListener('change',()=>{updatePrizeStatus(sel.getAttribute('data-claim'), sel.value); alert('ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ'); })); const sel=document.querySelector('#selfFundForm select[name=compIdSel]'); comps().forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.title; sel.appendChild(o); }); document.getElementById('selfFundForm').addEventListener('submit',(ev)=>{ev.preventDefault(); const f=ev.target; const cid=f.compIdSel.value; const amt=Number(f.amount.value||0); if(!amt||amt<=0) return alert('ุฃุฏุฎู ูุจูุบูุง ุตุญูุญูุง'); const ok=selfFundCompetition({ compId: cid, creatorEmail: auth?.email||'creator@demo', amount: amt }); if(ok){ alert('ุชู ุงูุชูููู ูู ุงููุญูุธุฉ'); location.reload(); } else { alert('ุชุนุฐุฑ ุงูุชูููู'); }}); </script>`; }