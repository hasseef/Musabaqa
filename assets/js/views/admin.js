
import { getAuth } from '../auth.js';
import { comps, createComp, computeFee, selfFundCompetition, canExposeSponsorship } from '../data.js';
import { downloadFile } from '../utils.js';
export default function Admin(){ const u=getAuth(); if(!u) return '<div class="card"><p>فضلاً سجّل الدخول.</p></div>'; if(u.role!=='admin') return '<div class="card"><p>هذه المنطقة للمدراء فقط.</p></div>';
  const list=comps(); const rows=list.map(c=>`<tr><td>${c.title}</td><td>${c.org}</td><td>${c.category}</td><td>${c.status}</td></tr>`).join('');
  return `<section class="grid"><div class="card"><h2>إدارة المسابقات</h2><form id="newComp" class="grid grid-2"><label>العنوان<input class="input" name="title" required></label><label>الجهة<input class="input" name="org" required></label><label>الفئة<input class="input" name="category" required></label><label>الحالة<select name="status"><option value="open">مفتوحة</option><option value="soon">قريباً</option><option value="closed">مغلقة</option></select></label><label>آخر موعد<input class="input" name="deadline" type="date" required></label><label>الميزانية (ريال)<input class="input" name="budget" type="number" step="100" placeholder="0"></label><label>نسبة المنصة (≤5%)<input class="input" name="feeRate" type="number" step="0.01" min="0" max="0.05" value="0.05"></label><label>وصف<textarea name="brief" required></textarea></label><label>تحتاج رعاية؟<select name="needsSponsorship"><option value="false">لا</option><option value="true">نعم</option></select></label><label>تمويل الجوائز المطلوب<input class="input" name="fundRequired" type="number" step="100" placeholder="0"></label><div class="row"><button class="btn">إضافة</button></div></form></div><div class="card"><h3>القائمة الحالية</h3><table class="table"><thead><tr><th>العنوان</th><th>الجهة</th><th>الفئة</th><th>الحالة</th></tr></thead><tbody>${rows}</tbody></table><hr/><h3>تمويل ذاتي من المحفظة</h3><form id="selfFundForm" class="grid grid-2"><label>المسابقة<select class="input" name="compIdSel"></select></label><label>المبلغ (ريال)<input class="input" name="amount" type="number" min="1" required></label><button class="btn">تمويل الآن</button></form></div></section><script type="module">import { getAuth } from '../auth.js'; import { createComp, comps, computeFee, selfFundCompetition, canExposeSponsorship } from '../data.js'; const form=document.getElementById('newComp'); const auth=getAuth(); if(auth && !canExposeSponsorship(auth.accountType)){ form.querySelector('[name=needsSponsorship]').closest('label').style.display='none'; } form.addEventListener('submit',e=>{e.preventDefault(); const fd=new FormData(form); createComp({ title:fd.get('title'), org:fd.get('org'), category:fd.get('category'), status:fd.get('status'), deadline:fd.get('deadline'), brief:fd.get('brief'), budget:Number(fd.get('budget')||0), feeRate:Number(fd.get('feeRate')||0.05), needsSponsorship:(fd.get('needsSponsorship')==='true')&&canExposeSponsorship(auth?.accountType), funding:{required:Number(fd.get('fundRequired')||0), collected:0, pledges:[]} }); alert('تمت الإضافة'); location.reload(); }); const sel=document.querySelector('#selfFundForm select[name=compIdSel]'); comps().forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.title; sel.appendChild(o); }); document.getElementById('selfFundForm').addEventListener('submit',(ev)=>{ev.preventDefault(); const f=ev.target; const cid=f.compIdSel.value; const amt=Number(f.amount.value||0); if(!amt||amt<=0) return alert('أدخل مبلغًا صحيحًا'); const ok=selfFundCompetition({ compId: cid, creatorEmail: auth?.email||'creator@demo', amount: amt }); if(ok){ alert('تم التمويل من المحفظة'); location.reload(); } else { alert('تعذر التمويل'); }}); </script>`; }